# Tangent SDK

A comprehensive Flutter SDK wrapper for Firebase, Mixpanel, Adjust, RevenueCat, App Tracking Transparency, and In-App
Review with unified analytics and crash reporting.

## Features

- ✅ **Firebase Integration**: Crashlytics and App Check
- 📊 **Analytics**: Mixpanel and Adjust
- 💰 **Revenue Management**: RevenueCat for subscriptions and purchases
- 🎯 **RevenueCat-Adjust Integration**: Automatic S2S revenue attribution with device identifier collection
- 🔒 **App Tracking Transparency**: iOS tracking permission handling
- ⭐ **In-App Review**: Request app-store reviews
- 🚑 **Unified Error Handling**: Centralized crash reporting and logging
- 🔄 **Automatic Renewal Detection**: Intelligent tracking of new vs. renewal purchases
- 📈 **Automatic Failure Tracking**: Purchase errors automatically sent to analytics

## Installation

Add this to your package's `pubspec.yaml` file:

```yaml
dependencies:
  tangent_sdk: ^0.0.4
```

Then run:

```bash
flutter pub get
```

## Dependencies

The SDK includes the following dependencies:

```yaml
dependencies:
  # Firebase
  firebase_core: ^3.14.0
  firebase_crashlytics: ^4.3.7
  firebase_app_check: ^0.3.2+7

  # Analytics
  mixpanel_flutter: ^2.4.0
  adjust_sdk: ^5.4.0

  # RevenueCat
  purchases_flutter: ^8.10.6

  # App Tracking Transparency
  app_tracking_transparency: ^2.0.6+1

  # In-App Review
  in_app_review: ^2.0.10

  # Utilities
  meta: ^1.11.0
```

## Setup

### 1. Basic Configuration

```dart
import 'package:tangent_sdk/tangent_sdk.dart';

final config = TangentConfig(
  // Analytics
  mixpanelToken: 'your_mixpanel_token',
  adjustAppToken: 'your_adjust_app_token',
  environment: TangentEnvironment.production,
  // or .sandbox

  // Revenue
  revenueCatApiKey: 'your_revenuecat_api_key',

  // Adjust subscription tracking
  adjustSubscriptionToken: 'your_adjust_subscribe_token',
  adjustSubscriptionRenewalToken: 'your_adjust_renew_token',
  automaticTrackSubscription: true,

  // Feature flags (all default to true)
  enableCrashlytics: true,
  enableAppCheck: true,
  enableAnalytics: true,
  enableRevenue: true,
);
```

### 2. Initialize SDK

```dart
import 'package:firebase_core/firebase_core.dart';
import 'firebase_options.dart'; // Generated by flutterfire configure

void main() async {
  WidgetsFlutterBinding.ensureInitialized();

  // Initialize Tangent SDK
  final tangentSDK = await TangentSDK.initialize(
    config: config,
    firebaseOptions: DefaultFirebaseOptions.currentPlatform, // Optional
  );

  runApp(MyApp());
}
```

## Usage

### Analytics

#### Track Events (Mixpanel)

```dart
await
TangentSDK.instance.trackEvent
('user_signup
'
, properties: {
'method': 'email',
'plan': 'premium',
});
```

#### Track Failure Events (Mixpanel)

```dart
await
TangentSDK.instance.trackFailureEvent
(
eventName: 'payment_failed',
failureReason: 'insufficient_funds',
properties: {'amount': 9.99},
);
```

#### Track Subscriptions (Adjust)

```dart
await
TangentSDK.instance.trackSubscription
(
eventToken: 'your_adjust_event_token',
price: 9.99,
currency: 'USD',
subscriptionId: 'sub_123',
eventName
:
'
premium_subscription
'
,
);
```

### Revenue Management

#### Get Products

```dart

final result = await
TangentSDK.instance.getProducts
(['product_id_1', 'product_id_2']);
result.when(
success: (products) => print('Products: $products'),
failure: (error) => print('Error: $error'
)
,
);
```

#### Purchase Product by ID

```dart

final result = await
TangentSDK.instance.purchaseProductById
('premium_monthly
'
,eventToken: 'your_adjust_event_token', // Optional
eventName: 'premium_subscription', // Optional
);
result.when(
success: (product) => print('Product: $product'),
failure: (error) => print('
Error:
$
error
'
)
,
);
```

#### Purchase Product Object

```dart

final productsResult = await
TangentSDK.instance.getProducts
(['
premium_monthly
'
]
);productsResult.when(
success: (products) async {
if (products.isNotEmpty) {
final result = await TangentSDK.instance.purchaseProduct(
products.first,
eventToken: 'your_adjust_event_token', // Optional
eventName: 'premium_subscription', // Optional
);
result.when(
success: (customerInfo) => print('Customer info: $customerInfo'),
failure: (error) => print('Error: $error'),
);
}
},
failure: (error) => print('Error:
$
error
'
)
,
);
```

#### Check Active Subscription

```dart

final result = await
TangentSDK.instance.checkActiveSubscription
();result.when
(
success: (hasSubscription) => print('Has subscription: $hasSubscription'),
failure: (error) => print('Error: $error'),
);
```

#### Check Active Subscription to Entitlement

```dart

final result = await
TangentSDK.instance.checkActiveSubscriptionToEntitlement
('premium_features
'
);result.when(
success: (hasAccess) => print('Has access: $hasAccess'),
failure: (error) => print('Error: $error'
)
,
);
```

#### Restore Purchases

```dart

final result = await
TangentSDK.instance.restorePurchases
();result.when
(
success: (customerInfo) => print('Restored: $customerInfo'),
failure: (error) => print('Error: $error'),
);
```

#### Get Offerings

```dart
// Get all offerings
final result = await
TangentSDK.instance.getOfferings
();result.when
(
success: (products) => print('All offerings: $products'),
failure: (error) => print('Error: $error'),
);

// Get specific offering
final result = await TangentSDK.instance.getOffering('premium_offering');
result.when(
success: (products) => print('Premium offering: $products'),
failure: (error) => print('Error: $error'),
);
```

#### Monitor Subscription Status

```dart
TangentSDK.instance.customerPurchasesInfoStream.listen
(
(info) {
print('Customer purchases updated: $info');
});
```

### App Tracking Transparency

#### Request Tracking Authorization

```dart
await
TangentSDK.instance.requestTrackingAuthorization
();
```

#### Get Current Status

```dart

final status = await
TangentSDK.instance.getTrackingStatus
();print
('Tracking status:
$status'
);
```

#### Get Advertising Identifier

```dart

final adId = await
TangentSDK.instance.getAdvertisingIdentifier
();print
('Ad ID:
$adId'
);
```

### In-App Review

#### Request Review

```dart
await
TangentSDK.instance.requestReview
();
```

#### Check if Review is Available

```dart

final available = await
TangentSDK.instance.isReviewAvailable
();if
(
available) {
await TangentSDK.instance.requestReview();
}
```

#### Open Store Listing

```dart
await
TangentSDK.instance.openStoreListing
(
appStoreId
:
'
your_app_store_id
'
);
```

### Crash Reporting & Logging

#### Record Errors

```dart
try {
// Your code
} catch (e, stackTrace) {
await TangentSDK.instance.recordError(
e,
stackTrace,
fatal: false,
customKeys: {'user_id': 'user_123'},
);
}
```

#### Log Messages

```dart
await
TangentSDK.instance.log
('User performed action X
'
);
```

## Configuration Options

### TangentConfig

| Parameter                        | Type                | Required | Default | Description                                      |
| -------------------------------- | ------------------- | -------- | ------- | ------------------------------------------------ |
| `mixpanelToken`                  | String?             | No       | null    | Mixpanel project token                           |
| `adjustAppToken`                 | String?             | No       | null    | Adjust app token                                 |
| `environment`                    | TangentEnvironment? | No       | null    | Adjust environment (production/sandbox)          |
| `revenueCatApiKey`               | String?             | No       | null    | RevenueCat public API key                        |
| `adjustSubscriptionToken`        | String?             | No       | null    | Adjust in-app subscription event token           |
| `adjustSubscriptionRenewalToken` | String?             | No       | null    | Adjust renewal event token                       |
| `automaticTrackSubscription`     | bool                | No       | true    | Automatically log subscription events via Adjust |
| `enableCrashlytics`              | bool                | No       | true    | Enable Firebase Crashlytics                      |
| `enableAppCheck`                 | bool                | No       | true    | Enable Firebase App Check                        |
| `enableAnalytics`                | bool                | No       | true    | Enable analytics services                        |
| `enableRevenue`                  | bool                | No       | true    | Enable RevenueCat integration                    |

### TangentEnvironment

```dart
enum TangentEnvironment {
  production,
  sandbox,
}
```

## Platform Requirements

### iOS

- iOS 12.0+
- For App Tracking Transparency: iOS 14.5+

### Android

- Android API level 21+

## Required Permissions

### iOS (Info.plist)

```xml

<key>NSUserTrackingUsageDescription</key><string>This app would like to access IDFA for analytics and personalized
ads.
</string>
```

### Android (android/app/src/main/AndroidManifest.xml)

```xml

<uses-permission android:name="android.permission.INTERNET" /><uses-permission
android:name="com.android.vending.BILLING" />
```

## Debug Logging

The SDK automatically logs initialization progress with emoji indicators:

- =% Service initialization started
-  Service initialization completed
- P Utility service initialization

## Error Handling

All revenue-related methods return a `Result<T>` type that can be handled using the `when` method:

```dart

final result = await
TangentSDK.instance.getProducts
(['
product_id
'
]
);result.when(
success: (data) {
// Handle success
},
failure: (error) {
// Handle error
},
);
```

### Automatic Error Tracking

The SDK automatically tracks purchase failures and sends them to Mixpanel with detailed error information:

```dart
// Purchase failures are automatically tracked with:
// - Error code and message
// - Product information
// - Original error details
```

### Automatic Subscription Tracking

The SDK automatically detects renewal purchases and tracks them appropriately:

- **New subscriptions**: Tracked with `adjustSubscriptionToken`
- **Renewals**: Tracked with `adjustSubscriptionRenewalToken`
- **Automatic detection**: Based on purchase history and original purchase date

### RevenueCat-Adjust Integration

The SDK includes automatic integration between RevenueCat and Adjust for precise revenue attribution. This enables server-to-server (S2S) revenue tracking from RevenueCat to Adjust with accurate campaign attribution.

#### Dashboard Setup

In addition to SDK configuration, you must configure the integration in the RevenueCat dashboard:

1. Navigate to **Integrations → Adjust**
2. Add your Adjust app tokens (iOS and Android)
3. Configure event tokens for different purchase types
4. Select revenue reporting preference (gross vs net)
5. Enable the integration

#### How It Works

1. **Automatic Device Identifier Collection**: During SDK initialization, the SDK automatically collects device identifiers required for attribution:

   - Adjust ID (required)
   - iOS: IDFA (advertising identifier), IDFV (vendor identifier)
   - Android: GPS AdId (Google advertising ID)

2. **RevenueCat Subscriber Attributes**: Identifiers are automatically set as subscriber attributes in RevenueCat

3. **Server-to-Server Events**: RevenueCat forwards purchase events to Adjust with proper attribution data

4. **Revenue Attribution**: Revenue appears in Adjust dashboard with accurate campaign attribution

#### Configuration

The integration is **enabled by default** and requires no additional code:

```dart
final config = TangentConfig(
  adjustAppToken: 'your_adjust_token',
  revenueCatApiKey: 'your_revenuecat_key',
  environment: TangentEnvironment.production,
  enableAnalytics: true,
  enableRevenue: true,
  // Integration is enabled by default
  enableRevenueCatAdjustIntegration: true, // Optional: explicitly set
);
```

#### Verification

Enable debug logging to verify identifier collection:

```dart
await TangentSDK.initialize(
  config: config,
  enableDebugLogging: true,
);
```

Look for these log messages:

```
[Revenue] Setting up RevenueCat-Adjust integration
[DeviceIdentifiers] Collected 3 identifiers: $adjustId, $idfa, $idfv
[Revenue] RevenueCat-Adjust integration configured with 3 identifiers
```

Verify in RevenueCat dashboard:

- Open any customer profile
- Check "Subscriber Attributes" section
- Confirm presence of `$adjustId`, `$idfa`/`$idfv` (iOS) or `$gpsAdId` (Android)

#### Important Notes

- **Double Tracking Prevention**: This S2S integration is separate from `automaticTrackSubscription`. Configure carefully to avoid double-counting revenue.
- **iOS IDFA**: Requires App Tracking Transparency (ATT) authorization. Set `enableAppTrackingTransparency: true` in config.
- **Minimum Revenue**: Adjust requires minimum revenue of 0.001 (free trials send events without revenue)
- **Timing**: Identifiers are collected during SDK initialization, before the first purchase

#### Disabling the Integration

If you prefer to handle attribution separately:

```dart
final config = TangentConfig(
  // ... other config ...
  enableRevenueCatAdjustIntegration: false, // Disable integration
);
```

#### Reference

- [RevenueCat Adjust Integration Guide](https://www.revenuecat.com/docs/integrations/attribution/adjust)

## Support

For issues and feature requests, please file an issue on the GitHub repository.

## License

This project is licensed under the MIT License - see the LICENSE file for details.
