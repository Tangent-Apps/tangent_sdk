# Tangent SDK

A comprehensive Flutter SDK wrapper for Firebase, Mixpanel, Adjust, RevenueCat, App Tracking Transparency, and In-App
Review with unified analytics and crash reporting.

## Features

- âœ… **Firebase Integration**: Crashlytics and App Check
- ðŸ“Š **Analytics**: Mixpanel and Adjust
- ðŸ’° **Revenue Management**: RevenueCat for subscriptions and purchases
- ðŸ”’ **App Tracking Transparency**: iOS tracking permission handling
- â­ **In-App Review**: Request app-store reviews
- ðŸš‘ **Unified Error Handling**: Centralized crash reporting and logging
- ðŸ”„ **Automatic Renewal Detection**: Intelligent tracking of new vs. renewal purchases
- ðŸ“ˆ **Automatic Failure Tracking**: Purchase errors automatically sent to analytics

## Installation

Add this to your package's `pubspec.yaml` file:

```yaml
dependencies:
  tangent_sdk: ^0.0.3
```

Then run:

```bash
flutter pub get
```

## Dependencies

The SDK includes the following dependencies:

```yaml
dependencies:
  # Firebase
  firebase_core: ^3.14.0
  firebase_crashlytics: ^4.3.7
  firebase_app_check: ^0.3.2+7

  # Analytics
  mixpanel_flutter: ^2.4.0
  adjust_sdk: ^5.4.0

  # RevenueCat
  purchases_flutter: ^8.10.6

  # App Tracking Transparency
  app_tracking_transparency: ^2.0.6+1

  # In-App Review
  in_app_review: ^2.0.10

  # Utilities
  meta: ^1.11.0
```

## Setup

### 1. Basic Configuration

```dart
import 'package:tangent_sdk/tangent_sdk.dart';

final config = TangentConfig(
  // Analytics
  mixpanelToken: 'your_mixpanel_token',
  adjustAppToken: 'your_adjust_app_token',
  environment: TangentEnvironment.production,
  // or .sandbox

  // Revenue
  revenueCatApiKey: 'your_revenuecat_api_key',

  // Adjust subscription tracking
  adjustSubscriptionToken: 'your_adjust_subscribe_token',
  adjustSubscriptionRenewalToken: 'your_adjust_renew_token',
  automaticTrackSubscription: true,

  // Feature flags (all default to true)
  enableCrashlytics: true,
  enableAppCheck: true,
  enableAnalytics: true,
  enableRevenue: true,
);
```

### 2. Initialize SDK

```dart
import 'package:firebase_core/firebase_core.dart';
import 'firebase_options.dart'; // Generated by flutterfire configure

void main() async {
  WidgetsFlutterBinding.ensureInitialized();

  // Initialize Tangent SDK
  final tangentSDK = await TangentSDK.initialize(
    config: config,
    firebaseOptions: DefaultFirebaseOptions.currentPlatform, // Optional
  );

  runApp(MyApp());
}
```

## Usage

### Analytics

#### Track Events (Mixpanel)

```dart
await
TangentSDK.instance.trackEvent
('user_signup
'
, properties: {
'method': 'email',
'plan': 'premium',
});
```

#### Track Failure Events (Mixpanel)

```dart
await
TangentSDK.instance.trackFailureEvent
(
eventName: 'payment_failed',
failureReason: 'insufficient_funds',
properties: {'amount': 9.99},
);
```

#### Track Subscriptions (Adjust)

```dart
await
TangentSDK.instance.trackSubscription
(
eventToken: 'your_adjust_event_token',
price: 9.99,
currency: 'USD',
subscriptionId: 'sub_123',
eventName
:
'
premium_subscription
'
,
);
```

### Revenue Management

#### Get Products

```dart

final result = await
TangentSDK.instance.getProducts
(['product_id_1', 'product_id_2']);
result.when(
success: (products) => print('Products: $products'),
failure: (error) => print('Error: $error'
)
,
);
```

#### Purchase Product by ID

```dart

final result = await
TangentSDK.instance.purchaseProductById
('premium_monthly
'
,eventToken: 'your_adjust_event_token', // Optional
eventName: 'premium_subscription', // Optional
);
result.when(
success: (product) => print('Product: $product'),
failure: (error) => print('
Error: 
$
error
'
)
,
);
```

#### Purchase Product Object

```dart

final productsResult = await
TangentSDK.instance.getProducts
(['
premium_monthly
'
]
);productsResult.when(
success: (products) async {
if (products.isNotEmpty) {
final result = await TangentSDK.instance.purchaseProduct(
products.first,
eventToken: 'your_adjust_event_token', // Optional
eventName: 'premium_subscription', // Optional
);
result.when(
success: (customerInfo) => print('Customer info: $customerInfo'),
failure: (error) => print('Error: $error'),
);
}
},
failure: (error) => print('Error: 
$
error
'
)
,
);
```

#### Check Active Subscription

```dart

final result = await
TangentSDK.instance.checkActiveSubscription
();result.when
(
success: (hasSubscription) => print('Has subscription: $hasSubscription'),
failure: (error) => print('Error: $error'),
);
```

#### Check Active Subscription to Entitlement

```dart

final result = await
TangentSDK.instance.checkActiveSubscriptionToEntitlement
('premium_features
'
);result.when(
success: (hasAccess) => print('Has access: $hasAccess'),
failure: (error) => print('Error: $error'
)
,
);
```

#### Restore Purchases

```dart

final result = await
TangentSDK.instance.restorePurchases
();result.when
(
success: (customerInfo) => print('Restored: $customerInfo'),
failure: (error) => print('Error: $error'),
);
```

#### Get Offerings

```dart
// Get all offerings
final result = await
TangentSDK.instance.getOfferings
();result.when
(
success: (products) => print('All offerings: $products'),
failure: (error) => print('Error: $error'),
);

// Get specific offering
final result = await TangentSDK.instance.getOffering('premium_offering');
result.when(
success: (products) => print('Premium offering: $products'),
failure: (error) => print('Error: $error'),
);
```

#### Monitor Subscription Status

```dart
TangentSDK.instance.customerPurchasesInfoStream.listen
(
(info) {
print('Customer purchases updated: $info');
});
```

### App Tracking Transparency

#### Request Tracking Authorization

```dart
await
TangentSDK.instance.requestTrackingAuthorization
();
```

#### Get Current Status

```dart

final status = await
TangentSDK.instance.getTrackingStatus
();print
('Tracking status: 
$status'
);
```

#### Get Advertising Identifier

```dart

final adId = await
TangentSDK.instance.getAdvertisingIdentifier
();print
('Ad ID: 
$adId'
);
```

### In-App Review

#### Request Review

```dart
await
TangentSDK.instance.requestReview
();
```

#### Check if Review is Available

```dart

final available = await
TangentSDK.instance.isReviewAvailable
();if
(
available) {
await TangentSDK.instance.requestReview();
}
```

#### Open Store Listing

```dart
await
TangentSDK.instance.openStoreListing
(
appStoreId
:
'
your_app_store_id
'
);
```

### Crash Reporting & Logging

#### Record Errors

```dart
try {
// Your code
} catch (e, stackTrace) {
await TangentSDK.instance.recordError(
e,
stackTrace,
fatal: false,
customKeys: {'user_id': 'user_123'},
);
}
```

#### Log Messages

```dart
await
TangentSDK.instance.log
('User performed action X
'
);
```

## Configuration Options

### TangentConfig

| Parameter                        | Type                | Required | Default | Description                                      |
|----------------------------------|---------------------|----------|---------|--------------------------------------------------|
| `mixpanelToken`                  | String?             | No       | null    | Mixpanel project token                           |
| `adjustAppToken`                 | String?             | No       | null    | Adjust app token                                 |
| `environment`                    | TangentEnvironment? | No       | null    | Adjust environment (production/sandbox)          |
| `revenueCatApiKey`               | String?             | No       | null    | RevenueCat public API key                        |
| `adjustSubscriptionToken`        | String?             | No       | null    | Adjust in-app subscription event token           |
| `adjustSubscriptionRenewalToken` | String?             | No       | null    | Adjust renewal event token                       |
| `automaticTrackSubscription`     | bool                | No       | true    | Automatically log subscription events via Adjust |
| `enableCrashlytics`              | bool                | No       | true    | Enable Firebase Crashlytics                      |
| `enableAppCheck`                 | bool                | No       | true    | Enable Firebase App Check                        |
| `enableAnalytics`                | bool                | No       | true    | Enable analytics services                        |
| `enableRevenue`                  | bool                | No       | true    | Enable RevenueCat integration                    |

### TangentEnvironment

```dart
enum TangentEnvironment {
  production,
  sandbox,
}
```

## Platform Requirements

### iOS

- iOS 12.0+
- For App Tracking Transparency: iOS 14.5+

### Android

- Android API level 21+

## Required Permissions

### iOS (Info.plist)

```xml

<key>NSUserTrackingUsageDescription</key><string>This app would like to access IDFA for analytics and personalized
ads.
</string>
```

### Android (android/app/src/main/AndroidManifest.xml)

```xml

<uses-permission android:name="android.permission.INTERNET" /><uses-permission
android:name="com.android.vending.BILLING" />
```

## Debug Logging

The SDK automatically logs initialization progress with emoji indicators:

- =% Service initialization started
-  Service initialization completed
- P Utility service initialization

## Error Handling

All revenue-related methods return a `Result<T>` type that can be handled using the `when` method:

```dart

final result = await
TangentSDK.instance.getProducts
(['
product_id
'
]
);result.when(
success: (data) {
// Handle success
},
failure: (error) {
// Handle error
},
);
```

### Automatic Error Tracking

The SDK automatically tracks purchase failures and sends them to Mixpanel with detailed error information:

```dart
// Purchase failures are automatically tracked with:
// - Error code and message
// - Product information
// - Original error details
```

### Automatic Subscription Tracking

The SDK automatically detects renewal purchases and tracks them appropriately:

- **New subscriptions**: Tracked with `adjustSubscriptionToken`
- **Renewals**: Tracked with `adjustSubscriptionRenewalToken`
- **Automatic detection**: Based on purchase history and original purchase date

## Support

For issues and feature requests, please file an issue on the GitHub repository.

## License

This project is licensed under the MIT License - see the LICENSE file for details.